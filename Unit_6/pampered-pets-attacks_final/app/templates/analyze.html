{% extends 'base.html' %}
{% block content %}
<div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
  <h1 class="mb-0">Attack Tree Analysis</h1>
  <div class="d-flex gap-2">
    <a href="{{ url_for('main.index') }}" class="btn btn-outline-secondary">Home</a>
    <a href="{{ url_for('main.download_spec') }}" class="btn btn-outline-primary">Download Updated Spec (YAML)</a>
    {% if png_path %}
    <a href="{{ url_for('main.download_png') }}" class="btn btn-outline-primary">Download PNG</a>
    {% endif %}
  </div>
</div>

<div class="card shadow-sm mb-4">
  <div class="card-header">
    <h5 class="mb-0">Edit Leaf Parameters</h5>
  </div>
  <div class="card-body">
    <form method="post" action="{{ url_for('main.recalculate') }}">
      <div class="table-responsive">
        <table class="table table-bordered table-sm align-middle">
          <thead class="table-light">
            <tr>
              <th scope="col">ID</th>
              <th scope="col">Label</th>
              <th scope="col">Probability</th>
              <th scope="col">Impact</th>
            </tr>
          </thead>
          <tbody>
            {% for leaf in leaves %}
            <tr>
              <td class="text-monospace">{{ leaf.id }}</td>
              <td>{{ leaf.label }}</td>
              <td>
                <input type="number" name="prob_{{ leaf.id }}" class="form-control form-control-sm" step="any" min="0"
                  max="1" value="{{ '' if leaf.prob is none else leaf.prob }}">
              </td>
              <td>
                <div class="input-group input-group-sm">
                  <span class="input-group-text">£</span>
                  <input type="number" name="impact_{{ leaf.id }}" class="form-control" step="any" min="0"
                    value="{{ '' if leaf.impact is none else leaf.impact }}">
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="d-flex justify-content-end">
        <button type="submit" class="btn btn-primary">Recalculate</button>
      </div>
    </form>
  </div>
</div>

{% if results_available %}
<div class="row g-4 mb-4">
  <div class="col-12 col-lg-6">
    <div class="card shadow-sm h-100">
      <div class="card-header d-flex justify-content-between">
        <h5 class="mb-0">Attack Tree Visualization</h5>
        <div>
          <span class="badge bg-primary-subtle text-primary border">P(top): {{ '%0.5f' | format(p_top) }}</span>
          <span class="badge bg-secondary-subtle text-secondary border ms-2">E[L]: £{{ '%0.2f' | format(e_loss)
            }}</span>
        </div>
      </div>
      <div class="card-body">
        {% if png_path %}
        <a href="#" data-bs-toggle="modal" data-bs-target="#treeZoomModal" title="Click to zoom">
          <img src="{{ url_for('static', filename=png_path) }}" class="img-fluid border rounded"
            alt="Attack tree visualisation" style="cursor: zoom-in;">
        </a>
        {% else %}
        <div class="text-muted">No visual yet.</div>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="col-12 col-lg-6">
    <div class="vstack gap-3">

      <!-- KPI card: always visible headline stats -->
      <div class="card">
        <div class="card-header"><strong>Summary</strong></div>
        <div class="card-body">
          <div class="row text-center g-3">
            <div class="col-6">
              <div class="text-muted small">Overall Likelihood of Attack P(top)</div>
              <div class="display-6">{{ p_top|pct(2) }}</div>
            </div>
            <div class="col-6">
              <div class="text-muted small">Estimated Financial Impact (E[L])</div>
              <div class="display-6">{{ e_loss|currency }}</div>
            </div>
          </div>
          <div class="small text-muted mt-2">
            P(top) = AND/OR composition. E[L] = Σ(leaf p × £).<br>
            <button id="formulaHelpBtn" type="button" class="btn btn-sm btn-outline-secondary" data-bs-toggle="popover"
              data-bs-trigger="onclick" aria-label="Show formulas">
              Show formulas and methodology
            </button>
          </div>
        </div>
      </div>
      <!-- Hidden formulas content (MathJax will render when popover opens) -->
      <div id="formulaHelpContent" class="d-none">
        {% raw %}
        <p><em>Notation:</em> \(P(n)\) = probability node \(n\) succeeds.
          Leaves have probability \(p_i\) and monetary impact \(I_i\) (GBP).</p>

        <p><strong>AND gate</strong> (all children must succeed):</p>
        \[
        P_{\text{AND}}(n) = \prod_{c \in \text{children}(n)} P(c)
        \]

        <p><strong>OR gate</strong> (any child can succeed):</p>
        \[
        P_{\text{OR}}(n) = 1 - \prod_{c \in \text{children}(n)} \bigl(1 - P(c)\bigr)
        \]

        <p><strong>Top event</strong> (root):</p>
        \[
        P(\text{top}) = 1 - \prod_{b=1}^{B} \bigl(1 - P(b)\bigr)
        \]

        <p><strong>Expected loss</strong> (additive leaf approximation):</p>
        \[
        \mathbb{E}[L] = \sum_{i \in \text{leaves}} p_i \, I_i
        \]

        <p><strong>Leaf contribution</strong> (Top Contributors):</p>
        \[
        C_i = p_i \, I_i, \qquad \%\,\text{of total} = \frac{C_i}{\mathbb{E}[L]}
        \]

        <p><strong>Sensitivity analysis</strong> (multiply one input; recompute):</p>
        \[
        p'_k = \min\!\bigl(1,\, m\, p_k\bigr) \quad\text{or}\quad I'_k = m\, I_k
        \]
        \[
        \mathbb{E}'[L] = \sum_i p'_i \, I'_i, \qquad P'(\text{top}) \text{ via the same AND/OR rules}
        \]
        {% endraw %}
        <p class="text-muted mb-0 small">We use a simple additive expected-loss model; scope leaves to avoid
          double-counting overlapping costs.</p>
      </div>
      <!-- Top contributors (unchanged, now sits below the KPI card) -->
      <div class="card">
        <div class="card-header"><strong>Top Contributors</strong></div>
        <div class="card-body">
          <table class="table table-sm">
            <thead class="table-light">
              <tr>
                <th>ID</th>
                <th>Label</th>
                <th class="text-end">Contribution</th>
              </tr>
            </thead>
            <tbody>
              {% for item in top3 %}
              <tr>
                <td>{{ item.id }}</td>
                <td class="label-wrap">{{ item.label }}</td>
                <td class="text-end">
                  {{ item.value|currency }}
                  <span class="text-muted">
                    ({{ (0 if e_loss==0 else item.value/e_loss)|pct(1) }})
                  </span>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          <div class="small text-muted">Contribution = leaf probability × leaf impact.</div>
        </div>
      </div>
    </div>

  </div>
</div>
{% endif %}

<div class="card shadow-sm">
  <div class="card-header">
    <h5 class="mb-0">Sensitivity Analysis</h5>
  </div>
  <div class="card-body">
    <form method="post" action="{{ url_for('main.run_sensitivity') }}" class="row g-3 align-items-end">
      <div class="col-md-5">
        <label for="leaf_id" class="form-label">Leaf</label>
        <select name="leaf_id" id="leaf_id" class="form-select">
          {% for leaf in leaves %}
          <option value="{{ leaf.id }}">{{ leaf.label }} ({{ leaf.id }})</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-3">
        <label for="multiplier" class="form-label">Multiplier</label>
        <input type="number" name="multiplier" id="multiplier" class="form-control" min="0" step="any" value="2">
      </div>
      <div class="col-md-4">
        <button type="submit" class="btn btn-outline-primary">Run Sensitivity</button>
      </div>
    </form>

    {% if sensitivity %}
    <hr>
    <div class="mt-2">
      <h6 class="mb-1">Sensitivity Results for {{ sensitivity.leaf_id }} × {{ sensitivity.multiplier }}</h6>
      <p class="mb-1">Overall Likelihood of Attack<strong>(P(top))</strong>: {{ '%0.5f' | format(sensitivity.p_top) }}
      </p>
      <p class="mb-3">Estimated Financial Impact<strong>(E[L])</strong>: {{ '%0.5f' | format(sensitivity.e_loss) }}</p>
      <form method="post" action="{{ url_for('main.apply_sensitivity') }}">
        <button type="submit" class="btn btn-warning">Apply</button>
      </form>
    </div>
    {% endif %}
  </div>
</div>

<div class="mt-3">
  <a href="{{ url_for('main.index') }}" class="btn btn-link">Back Home</a>
</div>
<div class="modal fade" id="treeZoomModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-xl">
    <div class="modal-content">
      <div class="modal-body p-0 position-relative">

        <!-- Controls -->
        <div class="position-absolute top-0 end-0 m-2 d-flex gap-2 z-3">
          <button class="btn btn-light btn-sm" id="zoomInBtn" title="Zoom in">+</button>
          <button class="btn btn-light btn-sm" id="zoomOutBtn" title="Zoom out">−</button>
          <button class="btn btn-light btn-sm" id="resetBtn" title="Reset">Reset</button>
          <button class="btn btn-light btn-sm" data-bs-dismiss="modal" aria-label="Close">Close</button>
        </div>

        <!-- Pan/zoom viewport -->
        <div id="pzViewport" class="pz-viewport bg-dark">
          <img id="pzTarget" class="pz-target" alt="Attack tree (zoomable)"
            src="{{ url_for('static', filename=png_path) }}">
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}